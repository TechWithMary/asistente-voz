<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Cuentas de Cobro</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f5f5f5; color: #333; }
        h1 { color: #004aad; }
        p { max-width: 500px; margin: 0 auto 20px; }
        button { background: #4CAF50; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 50px; cursor: pointer; transition: background 0.3s; }
        button:active, button.recording { background: #45a049; }
        #status { margin-top: 20px; font-style: italic; color: #666; }
        #error { color: red; margin-top: 10px; }
        .manual-link { margin-top: 30px; }
        .manual-link a { color: #004aad; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Asistente de Cuentas de Cobro</h1>
    <p>Graba una nota de voz con los detalles de la cuenta (ej: "N√∫mero de orden 001, nombre raz√≥n Mary Cardona, NIT 123456789, tel√©fono +57 300 1234567, correo mary@blocflux.co, empresa Serna SAS, concepto automatizaci√≥n, valor 2500000, m√©todo transferencia bancaria, cuenta 123456789, fecha hoy, firma Mary Cardona, correo cliente mari.99.mca@gmail.com").</p>
    <button id="recordBtn">Mant√©n Presionado para Grabar üéôÔ∏è</button>
    <div id="status">Esperando instrucci√≥n...</div>
    <div id="error"></div>
    <div class="manual-link">
        <a href="https://tu-n8n.com/webhook/form/8b9ad2ef-0f52-4373-a8e5-81280a75b256" target="_blank">O usa el formulario manual</a>
    </div>

    <script>
        const recordBtn = document.getElementById('recordBtn');
        const status = document.getElementById('status');
        const errorDiv = document.getElementById('error');
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        const BACKEND_URL = '/api/procesar-audio';  // Endpoint en Vercel

        recordBtn.addEventListener('mousedown', async () => {
            try {
                status.textContent = 'Grabando... (suelta para detener)';
                errorDiv.textContent = '';
                recordBtn.classList.add('recording');
                recordBtn.textContent = 'Grabando...';

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioChunks = [];

                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'nota-de-voz.webm');

                    status.textContent = 'Procesando audio con Gemini...';
                    const response = await fetch(BACKEND_URL, { method: 'POST', body: formData });

                    if (response.ok) {
                        const result = await response.json();
                        status.textContent = result.message || '¬°Listo! Revisa tu correo en unos segundos.';
                        alert('¬°√âxito! La cuenta de cobro se gener√≥ y envi√≥ autom√°ticamente.');
                    } else {
                        const err = await response.json();
                        throw new Error(err.message || 'Error en el procesamiento del audio');
                    }

                    stream.getTracks().forEach(track => track.stop());
                    recordBtn.classList.remove('recording');
                    recordBtn.textContent = 'Mant√©n Presionado para Grabar üéôÔ∏è';
                };

                mediaRecorder.start();
                isRecording = true;
            } catch (err) {
                errorDiv.textContent = 'Error: ' + err.message + ' (verifica permisos del micr√≥fono)';
                console.error(err);
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'Mant√©n Presionado para Grabar üéôÔ∏è';
            }
        });

        recordBtn.addEventListener('mouseup', () => {
            if (isRecording && mediaRecorder) {
                mediaRecorder.stop();
                isRecording = false;
                status.textContent = 'Deteniendo grabaci√≥n...';
            }
        });

        // Soporte para touch en m√≥viles (touchstart/touchend)
        recordBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            recordBtn.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
        }, { passive: false });

        recordBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            recordBtn.dispatchEvent(new MouseEvent('mouseup', { bubbles: true }));
        }, { passive: false });
    </script>
</body>
</html>